---
title: Report on dataset from `AusTraits` data compilation
output:
  html_document:
    df_print: kable
    highlight: tango
    keep_md: no
    smart: no
    theme: yeti
    toc: yes
    toc_depth: 3
    toc_float:
      collapsed: false
      smooth_scroll: true
params:
    trait_name: provide
    austraits: provide
editor_options:
  chunk_output_type: console
---

<!-- hack to get indentation on 3rd level of floating TOC; see
https://stackoverflow.com/questions/46201753/rmarkdown-indentation-of-toc-items-in-html-output
 -->

<script>
$(document).ready(function() {
  $items = $('div#TOC li');
  $items.each(function(idx) {
    num_ul = $(this).parentsUntil('#TOC').length;
    $(this).css({'text-indent': num_ul * 10, 'padding-left': 0});
  });

});
</script>

```{r setup, echo=FALSE, message=FALSE, warning=FALSE, results="hide"}
# knitr defaults
knitr::opts_chunk$set(echo = FALSE, cache = FALSE)

# default for table format
options(knitr.table.format = "html")

# remove warnings from dplyr about "summarise"
options(dplyr.summarise.inform = FALSE)

# Guidelines for writing report code
# - use tidyverse style and format: http://htmlpreview.github.io/?https://github.com/nicercode/2018_BEES_regression/blob/master/tidyverse.html
# - use kableExtra for styling: https://cran.r-project.org/web/packages/kableExtra/vignettes/awesome_table_in_html.html
# - use knitr chunck options: https://rmarkdown.rstudio.com/lesson-3.html

# Some useful functions


#' Generate hyperlink for markdown and html
#'
#' Generate hyperlink for markdown and html files
#'
#' @param link character string for the url link
#' @param text character string for the text to display
#' @param type file type, default is markdown "md" otherwise html
#'
#' @return character string with the text and link formatted for md and html
#' @export
#'
#' @examples as_link("www.austraits.org", "austraits")
as_link <- function(link, text, type = "md") {
  if (type == "md") {
    sprintf("[%s](%s)", text, link)
  } else {
    sprintf("<a href='%s'> %s </a>", link, text)
  }
}


#' Get SHA link from Github
#'
#' Get SHA link using the util_get_SHA() function. The link generated leads to the latest
#' commit for the Github repository. SHA is the abbreviated SHA-1 40 digit
#' hexadecimal number which Github uses to track commits and changes made to a repository.
#'
#' @param ... arguments passed to the util_get_SHA()
#'
#' @return SHA link to a github commit as a character string formatted using markdown syntax
util_get_SHA_link <- function(...) {
  sha <- util_get_SHA(...)
  as_link(sprintf("https://github.com/traitecoevo/austraits/tree/%s", sha), sha)
}

```

```{r, echo=FALSE, message=FALSE, warning=FALSE, results="hide"}
library(traits.build)
library(austraits)
library(knitr)
library(kableExtra)


my_kable_styling <- util_kable_styling_html

definitions <- austraits$definitions
trait_data <- extract_trait(austraits, trait, partial_matches_allowed = F)
trait_definition <- austraits$definitions[[trait]]
```


`r print(trait_name)` is defined as definitions`r trait_definition$description %>% str_replace("^.*\\;", "")`

For this trait, AusTraits includes a total of `r trait_data$traits %>% nrow()` records'. This includes:

  - data for `trait_data$traits$taxon_name %>% unique() %>% length` species.

  - data for `trait_data$traits$family %>% unique() %>% length()` families: `trait_data$traits$family %>% unique() %>% paste0(collapse = "; ")`

  - data from `trait_data$traits$dataset_id %>% unique() %>% length()` datasets: `trait_data$traits$dataset_id %>% unique() %>% paste0(collapse = "; ")`

  - `r trait_data$traits %>% filter(!is.na(`latitude (deg)`)) %>% length()` observations that are georeferenced.

Some additional information about this trait:

```{r, echo=FALSE, message=FALSE}
writeLines(
    sprintf("- **label**: %s", trait_definition$label),
    sprintf("- **units**: %s", trait_definition$units),
    sprintf("- **allowable range**: %s - %s %s", trait_definition$allowed_values_min,
            trait_definition$allowed_values_max, trait_definition$units)
)
```

See the AusTraits Plant Dictionary (`r trait_definition$entity_URI`) for additional information about this trait.

## Extract trait categories

```{r, echo=FALSE, message=FALSE}
tmp <- trait_data$traits %>% filter(!trait_name %in% c("flowering_time", "fruiting_time", "recruitment_time", "germination_time"))
traits <- tmp$trait_name %>% unique() %>% sort()
traits_numeric <- traits[util_extract_list_element(traits, definitions, "type") == "numeric"]
traits_categorical <- traits[util_extract_list_element(traits, definitions, "type") != "numeric"]
```

Visualising data records across families indicates the taxonomic breadth of information for this trait.

```{r numerical, results='asis', echo=FALSE, message=FALSE, warning=FALSE, fig.height=10, fig.width=10, eval=TRUE}
trait_data_beeswarm <- trait_data 

trait_data_beeswarm$traits <- trait_data$traits %>%
    filter(!value_type %in% c("bin", "range")) %>%
    mutate(value = as.numeric(value))

austraits::plot_trait_distribution_beeswarm(trait_data_beeswarm, trait, "family", hide_ids = FALSE)
```

Visualising data records across Australia indicates the geographic breadth of data collection for this trait

```{r numerical, results='asis', echo=FALSE, message=FALSE, warning=FALSE, fig.height=10, fig.width=10, eval=TRUE}
trait_data_map <- trait_data %>%
    join_location_coordinates()

trait_data_map$traits <- trait_data_map$traits  %>%
    filter(!is.na(`latitude (deg)`)) %>%
    mutate(value = as.numeric(value))

austraits::plot_locations(trait_data_map)
```

## Categorical traits

```{r categorical, results='asis', echo=FALSE, eval=TRUE}

```


