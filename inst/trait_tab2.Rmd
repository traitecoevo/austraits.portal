---
title: trait tab
output:
  html_document:
    df_print: kable
    highlight: tango
    keep_md: no
    smart: no
    theme: yeti
    toc: yes
    toc_depth: 3
    toc_float:
      collapsed: false
      smooth_scroll: true
params:
    trait_name: provide
    austraits: provide
editor_options:
  chunk_output_type: console
---

```{r, echo=FALSE, message=FALSE, warning=FALSE, results="hide"}
library(traits.build)
library(austraits)
library(knitr)
library(kableExtra)
library(tidyverse)

austraits <- readRDS("C:/Users/Lizzy/Documents/GitHub/austraits.portal/ignore/austraits.rds")

my_kable_styling <- util_kable_styling_html

trait <- "leaf_area"
trait_data <- extract_trait(austraits, trait, partial_matches_allowed = F)
trait_data_flat <- austraits::flatten_database(trait_data)
trait_definition <- austraits$definitions[[trait]]

tmp <- trait_data$traits %>% filter(!trait_name %in% c("flowering_time", "fruiting_time", "recruitment_time", "germination_time"))
traits <- tmp$trait_name %>% unique() %>% sort()
traits_numeric <- traits[util_extract_list_element(traits, austraits$definitions, "type") == "numeric"]
traits_categorical <- traits[util_extract_list_element(traits, austraits$definitions, "type") != "numeric"]
```

**`r trait`** is defined as: **`r trait_definition$description %>% str_replace("^.*\\;", "")`**

For this trait, AusTraits includes a total of **`r trait_data_flat %>% nrow()`** records. This includes:

- data for **`r trait_data_flat$taxon_name %>% unique() %>% length()`** species.

- data for **`r trait_data_flat$family %>% unique() %>% length()`** families.

- data from **`r trait_data_flat$dataset_id %>% unique() %>% length()`** datasets: `r trait_data_flat$dataset_id %>% unique() %>% paste0(collapse = "; ")`

- of the total, **`r trait_data_flat %>% filter(!is.na(.data[["latitude (deg)"]])) %>% nrow()`** of the observations are georeferenced. The other records generally represent species-level data that apply across the species' range.


Some additional information about this trait:

- **label**: `r trait_definition$label`  

- **additional comments**: `r trait_definition$comments`

```{r, echo=FALSE, message=FALSE}
if(isTRUE(traits_numeric == trait)) {
  
  writeLines(sprintf("- **units**: %s", trait_definition$units))
  
  writeLines(sprintf("- **allowable range**: %s -  %s %s\n", trait_definition$allowed_values_min, trait_definition$allowed_values_max, trait_definition$units))

}
```
  
- **categorical trait values**:

```{r, echo=FALSE, message=FALSE}
if(isTRUE(traits_categorical == trait)) {
  
trait_definition$allowed_values_levels %>% 
  traits.build::convert_list_to_df1() %>% 
  rename(description = value, value = key) %>%
  kable(caption = "Categorical trait values") %>%
  kable_classic()

}
```

See the AusTraits Plant Dictionary (`r trait_definition$entity_URI`) for additional information about this trait.

### Visualising trait data

The data displays shown below include all data for this trait, including data collected on individuals of all age classes (seedling, sapling, adult), both field-collected and experimental data, and data representing individuals and population means.

Visualising data records across the families with the most data for the trait indicates the taxonomic breadth of information for this trait.

```{r results='asis', echo=FALSE, message=FALSE, warning=FALSE, fig.height=10, fig.width=6, eval=TRUE}
if(isTRUE(traits_numeric == trait)) {

    trait_data_beeswarm <- trait_data_flat %>%
      filter(!value_type %in% c("bin", "range")) %>%
      mutate(value = as.numeric(value))
  
  austraits::plot_trait_distribution_beeswarm(trait_data_beeswarm, trait, "family", hide_ids = FALSE)
}
```

```{r categorical, results='asis', echo=FALSE, eval=TRUE, warning=FALSE, fig.height=10, fig.width=6, message=FALSE}
plot_categorical_trait_distribution <- function(data, trait, family_count) {
  
  # if relational database, retain traits layer only
  if (is.null(dim(data))) {
    data <- (data %>% austraits::join_taxa(vars = "family"))$traits
  }
  
  # filter to relevant trait
  data <- data %>% dplyr::filter(trait_name == trait)
  
  # determine proportion of observations for each categorical trait value by taxon
  prop_by_species <- data %>%
    dplyr::select(family, taxon_name, value, dataset_id, observation_id) %>%
    # separate instances with multiple strings in a value cell; as in polymorphic scorings for a single observation
    tidyr::separate_longer_delim(value, delim = " ") %>%
    # probably not necessary, but good to retain
    dplyr::distinct() %>%
    # for each observation, if multiple values, give each of them a fractional weight
    dplyr::group_by(family, taxon_name, dataset_id, observation_id) %>%
    dplyr::mutate(
        total_per_obs = n(),
        scaled_by_obs = 1/total_per_obs
      ) %>%
    dplyr::ungroup() %>%
    dplyr::select(-total_per_obs) %>%
    dplyr::group_by(family, taxon_name, value) %>%
    # calculate counts for each categorical value, for each taxon, across all observations  
      dplyr::mutate(counts = sum(scaled_by_obs)) %>%
    dplyr::ungroup() %>%
    dplyr::distinct(family, taxon_name, value, counts) %>%
    dplyr::group_by(family, taxon_name) %>%
      dplyr::mutate(total = sum(counts)) %>%
    dplyr::ungroup() %>%
    dplyr::mutate(prop = counts/total) %>%
    dplyr::select(-total, -counts)
  
  # create dataframe of the 50 families with the greatest number of taxa with trait scores
  most_common_families <- prop_by_species %>%
    dplyr::distinct(family, taxon_name) %>%
    dplyr::group_by(family) %>%
      dplyr::mutate(species_per_family = n()) %>%
    dplyr::ungroup() %>%
    dplyr::distinct(family, species_per_family) %>%
    dplyr::arrange(-species_per_family) %>%
    dplyr::slice(1:family_count)

  # now combine species-level proportions for each categorical trait value, 
  # outputting family-level proportions instead
  prop_by_family <- prop_by_species %>%
    dplyr::select(-taxon_name) %>%
    dplyr::filter(family %in% most_common_families$family) %>%
    dplyr::group_by(family, value) %>%
      dplyr::mutate(counts_per_value = sum(prop)) %>%
    dplyr::ungroup() %>%
    dplyr::distinct(family, value, counts_per_value) %>%
    dplyr::group_by(family) %>%
    dplyr::mutate(
        total = sum(counts_per_value)
      ) %>%
    dplyr::ungroup() %>%
    dplyr::mutate(prop = counts_per_value/total) %>%
    dplyr::select(-total)
  
  # create ordered vector, indicating frequency of each categorical trait value
  # for ordering the x-axis
  counts_by_value <- prop_by_family %>%
    dplyr::group_by(value) %>%
      dplyr::mutate(total_counts = sum(counts_per_value)) %>%
    dplyr::ungroup() %>%
    dplyr::distinct(value, total_counts) %>%
    dplyr::arrange(-total_counts) %>%
    dplyr::pull(value)
  
  #turn categorical trait value into a factor, order by relative common-ness across all taxa
  prop_by_family <- prop_by_family %>%
    dplyr::mutate(value = factor(value, levels = counts_by_value))
  
  # vs lowest prop of data for the most common categorical trait value,
  # for families without any records for most common categorical trait value, order by next value, etc
  family_vector <- prop_by_family %>%
    # filter dataframe to only be the most common categorical trait value
    dplyr::arrange(value, -prop) %>%
    dplyr::mutate(row_counter = row_number()) %>%
    dplyr::group_by(family) %>%
    dplyr::mutate(family_order = min(row_counter)) %>%
    dplyr::arrange(family_order) %>%
    dplyr::slice(1) %>%
    dplyr::ungroup() %>%
    dplyr::arrange(family_order) %>% 
    dplyr::pull(family)

  prop_by_family <- prop_by_family %>%
    # turn family into a factor, ordered by the proportion of species with the most common categorical trait value
    dplyr::mutate(family = factor(family, levels = family_vector)) %>%
    # occassional observations don't have families attached, remove those
    dplyr::filter(!is.na(family)) %>%
    dplyr::arrange(family)
  
  ggplot(aes(y = family, x = value, fill = prop, size = counts_per_value), data = prop_by_family %>% filter(prop > 0)) +
    geom_jitter(shape = 21, width = 0.15, height = 0) +
    scale_size_continuous() +
    scale_fill_viridis_c(option = "C") +
    labs(
      x = NULL, y = NULL, 
      fill = "prop of species in family", 
      size = "species count"
    ) +
    theme_minimal() +
    theme(
      axis.line.y = element_blank(),
      axis.text.x = element_text(angle = 45, hjust = 1),
      panel.grid.major.x = element_blank(),
      panel.grid.minor.x = element_blank(),
      panel.grid.minor.y = element_blank(),
      panel.grid.major.y = element_line(size = 0.05)
    )   
}


if(isTRUE(traits_categorical == trait)) {
  plot_categorical_trait_distribution(trait_data_flat, trait, family_count = 50)
}
```

Visualising data records across Australia indicates the geographic breadth of data collection for this trait

```{r results='asis', echo=FALSE, message=FALSE, warning=FALSE, fig.height=6, fig.width=6, eval=TRUE}
  trait_data_map <- trait_data_flat %>%
    filter(!is.na(`latitude (deg)`)) %>%
    mutate(value = as.numeric(value))

austraits::plot_locations(trait_data_map)
```




